<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<title>MarketMonitoring</title>
<script src='https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js'></script>
<style>.menu{padding:4px 8px;border:1px solid #ccc;background:#fff;cursor:pointer;} .menu.active{background:#1890ff;color:#fff;}</style>
</head>
<body>
<h1>Market Monitoring</h1>
<div style='display:flex;gap:8px;flex-wrap:wrap'>
  <button class='menu top active' onclick="showTab('holdings',this)">持仓</button>
  <button class='menu top' onclick="showTab('predict',this)">预测</button>
  <button class='menu top' onclick="showTab('derivs',this)">衍生品</button>
  <button class='menu top' onclick="showTab('orders',this)">挂单</button>
  <button class='menu top' onclick="showTab('trades',this)">成交</button>
  <button class='menu top' onclick="showTab('cancels',this)">取消</button>
  <button class='menu top' onclick="showTab('settings',this)">设置</button>
</div>
<div id='sym-menu' style='display:none;gap:8px;flex-wrap:wrap;margin-top:8px'></div>
<div id='tab-holdings'>
  <div id='holdings-bar' style='width:800px;height:320px;border:1px solid #ccc;margin-top:10px'></div>
  <div id='holdings-line' style='width:800px;height:320px;border:1px solid #ccc;margin-top:10px'></div>
</div>
<div id='tab-predict' style='display:none'>
  <div id='predict-json' style='margin-top:10px'></div>
</div>
<div id='tab-derivs' style='display:none'>
  <div style='display:flex;align-items:center;gap:10px;margin:10px 0;color:#555;font-size:13px'>
    <span>时间已转换为中国时区 (UTC+8)</span>
    <div id='backfill-buttons' style='display:flex;gap:4px'>
      <button class='menu' onclick='triggerBackfill(1,this)'>回填1h</button>
      <button class='menu' onclick='triggerBackfill(4,this)'>回填4h</button>
      <button class='menu' onclick='triggerBackfill(12,this)'>回填12h</button>
      <button class='menu' onclick='triggerBackfill(24,this)'>回填24h</button>
    </div>
    <div id='window-buttons' style='display:flex;gap:4px'></div>
  </div>
  <h3 id='derivs-sym' style='margin:0'></h3>
  <div id='derivs-wrap' style='display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:start'></div>
  <div id='backfill-note' style='color:#888;font-size:12px;margin-top:4px'></div>
</div>
<div id='tab-orders' style='display:none'>
  <div id='depth-buttons' style='margin-top:10px;display:flex;gap:4px'></div>
  <div id='orders-wrap' style='margin-top:10px;width:100%'></div>
</div>
<div id='tab-trades' style='display:none'>
  <div id='trades-wrap' style='margin-top:10px;width:100%'></div>
</div>
<div id='tab-cancels' style='display:none'>
  <div id='cancels-wrap' style='margin-top:10px;width:100%'></div>
</div>
<div id='tab-settings' style='display:none'>
  <h3>系统设置</h3>
  <textarea id='settings-text' style='width:100%;height:200px'></textarea>
  <div style='text-align:right;margin-top:5px'>
    <button onclick='saveSettings()'>保存</button>
  </div>
</div>
<script>
const derivSyms=__SYMS__;
function displaySym(s){return s.replace(/USDT$/,'');}
const symDecimals={
  'XRPUSDT':5,
  'XLMUSDT':4,
  'DOGEUSDT':4,
  'SUIUSDT':4,
  'PEPEUSDT':8,
  '1000PEPEUSDT':7,
  'PUMPUSDT':6,
  'FARTCOINUSDT':4,
  'WLFIUSDT':4
};
let currentSym=derivSyms[0];
let currentTab='holdings';
const symMenu=document.getElementById('sym-menu');
const depthLevels=[500,1000,5000];
let currentDepth=500;
const depthButtons=document.getElementById('depth-buttons');
const vaPercents=[0.7,0.75,0.8,0.85];
let currentVA=0.7;
const windowOptions=['5m','15m','30m','1h','4h','12h','24h'];
let currentWindow='24h';
const windowButtons=document.getElementById('window-buttons');
let latestPrice=0;
let ordersChart=null;
const ordersZoom={};
function updateOrdersTitle(){
  if(currentTab!=='orders') return;
  const h=document.querySelector('#orders-wrap h3');
  if(!h) return;
  const dec=symDecimals[currentSym]??2;
  const p=Number(latestPrice);
  h.textContent=`${displaySym(currentSym)} Bids/Asks${p? ' '+p.toFixed(dec):''}`;
}
function initSymMenu(){
  if(symMenu.hasChildNodes()) return;
  derivSyms.forEach((s,i)=>{
    let b=document.createElement('button');
    b.textContent=displaySym(s);
    b.className='menu';
    if(i===0) b.classList.add('active');
    b.onclick=()=>showSym(s,b);
    symMenu.appendChild(b);
  });
}
function initDepthButtons(){
  if(depthButtons.hasChildNodes()) return;
  let label=document.createElement('span');
  label.textContent='市场深度';
  depthButtons.appendChild(label);
  depthLevels.forEach(d=>{
    let b=document.createElement('button');
    b.textContent=d;
    b.className='menu';
    if(d===currentDepth) b.classList.add('active');
    b.onclick=()=>{
      currentDepth=d;
      depthButtons.querySelectorAll('.menu').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById('orders-wrap').innerHTML='';
      ordersChart=null;
      load();
    };
    depthButtons.appendChild(b);
  });
}
function initVAButtons(){
  const btns=document.getElementById('va-buttons');
  if(!btns || btns.hasChildNodes()) return;
  vaPercents.forEach(p=>{
    let b=document.createElement('button');
    b.textContent=Math.round(p*100)+'%';
    b.className='menu';
    if(p===currentVA) b.classList.add('active');
    b.onclick=()=>{
      currentVA=p;
      btns.querySelectorAll('.menu').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      load();
    };
    btns.appendChild(b);
  });
}
function initWindowButtons(){
  if(windowButtons.hasChildNodes()) return;
  windowOptions.forEach(w=>{
    let b=document.createElement('button');
    b.textContent=w.toUpperCase();
    b.className='menu';
    if(w===currentWindow) b.classList.add('active');
    b.onclick=()=>{
      currentWindow=w;
      windowButtons.querySelectorAll('.menu').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById('derivs-wrap').innerHTML='';
      load();
    };
    windowButtons.appendChild(b);
  });
}
async function showSym(sym,btn){
  currentSym=sym;
  symMenu.querySelectorAll('.menu').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  if(currentTab==='derivs') document.getElementById('derivs-wrap').innerHTML='';
  if(currentTab==='orders'){document.getElementById('orders-wrap').innerHTML='';ordersChart=null;}
  if(currentTab==='trades') document.getElementById('trades-wrap').innerHTML='';
  if(currentTab==='cancels') document.getElementById('cancels-wrap').innerHTML='';
  await refreshPrice();
  load();
}
function showTab(tab,btn){
  currentTab=tab;
  document.getElementById('tab-holdings').style.display=(tab==='holdings')?'block':'none';
  document.getElementById('tab-predict').style.display=(tab==='predict')?'block':'none';
  document.getElementById('tab-derivs').style.display=(tab==='derivs')?'block':'none';
  document.getElementById('tab-orders').style.display=(tab==='orders')?'block':'none';
  document.getElementById('tab-trades').style.display=(tab==='trades')?'block':'none';
  document.getElementById('tab-cancels').style.display=(tab==='cancels')?'block':'none';
  document.getElementById('tab-settings').style.display=(tab==='settings')?'block':'none';
  document.querySelectorAll('.menu.top').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const needsSym=['derivs','orders','trades','cancels'].includes(tab);
  symMenu.style.display=needsSym?'flex':'none';
  if(needsSym) initSymMenu();
  if(tab==='orders') initDepthButtons();
  if(tab==='derivs') initWindowButtons();
  if(tab==='settings') loadSettings();
  load();
}
async function loadSettings(){
  let cfg=await fetch('/settings').then(r=>r.json());
  document.getElementById('settings-text').value=JSON.stringify(cfg,null,2);
}
async function saveSettings(){
  try{
    let data=JSON.parse(document.getElementById('settings-text').value);
    await fetch('/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    alert('已保存');
  }catch(e){alert('JSON 无效');}
}
function toUTC8(arr){
  return (arr||[]).map(t=>{
    try{
      let d=new Date(t);
      if(!isNaN(d)){
        d=new Date(d.getTime()+8*3600*1000);
        let m=(d.getUTCMonth()+1).toString().padStart(2,'0');
        let day=d.getUTCDate().toString().padStart(2,'0');
        let hh=d.getUTCHours().toString().padStart(2,'0');
        let mm=d.getUTCMinutes().toString().padStart(2,'0');
        return `${m}-${day} ${hh}:${mm}`;
      }
    }catch(e){}
    return t;
  });
}
async function refreshPrice(){
  try{
    const data=await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${currentSym}`).then(r=>r.json());
    latestPrice=Number(data.price)||0;
    updateOrdersTitle();
    if(currentTab==='trades'){
      load();
    }
  }catch(e){
    console.error('Failed to fetch latest price',e);
  }
}
async function load(){
  if(currentTab==='holdings'){
    let snap=await fetch('/mm/holdings').then(r=>r.json());
    let bar=echarts.init(document.getElementById('holdings-bar'));
    bar.setOption({title:{text:'最近快照'},xAxis:{type:'category',data:Object.keys(snap.totals)},yAxis:{type:'value'},dataZoom:[{type:'inside'}],series:[{data:Object.values(snap.totals),type:'bar'}]});
    let hist=await fetch('/chart/holdings').then(r=>r.json());
    let line=echarts.init(document.getElementById('holdings-line'));
    line.setOption({tooltip:{trigger:'axis'},legend:{data:['BTC','ETH','USDT','USDC']},xAxis:{type:'category',data:hist.time},yAxis:{type:'value'},dataZoom:[{type:'inside'}],series:[{name:'BTC',type:'line',data:hist.BTC},{name:'ETH',type:'line',data:hist.ETH},{name:'USDT',type:'line',data:hist.USDT},{name:'USDC',type:'line',data:hist.USDC}]});
  }else if(currentTab==='predict'){
    let pred1=await fetch('/predict/BTCUSDT').then(r=>r.json());
    let pred2=await fetch('/predict/ETHUSDT').then(r=>r.json());
    document.getElementById('predict-json').innerHTML='<h3>预测信号</h3><p style="color:#555;font-size:14px">数据来源:data/holdings_history.json, 信号计算为 ΔBTC/ETH - 0.8·ΔUSDT - 0.4·ΔUSDC</p><pre>'+JSON.stringify([pred1,pred2],null,2)+'</pre>';
  }else if(currentTab==='derivs'){
    document.getElementById('derivs-sym').textContent=displaySym(currentSym);
    let wrap=document.getElementById('derivs-wrap');
    if(!wrap.hasChildNodes()){
      ['price','funding-binance','funding-bybit','funding-okx','basis','oi'].forEach(kind=>{let box=document.createElement('div');box.id='derivs-'+kind;box.style.cssText='width:100%;height:260px;border:1px solid #ccc';wrap.appendChild(box);});
    }
    let d=await fetch(`/chart/derivs?symbol=${currentSym}&window=${currentWindow}`).then(r=>r.json());
    let x=toUTC8(d.timestamps);
    const toSeries = (arr, fn = v => v) =>
      (arr ?? []).map(v => {
        const num = Number(v);
        // Treat null/undefined, zero, or NaN as gaps so lines connect
        return (v == null || num === 0 || Number.isNaN(num)) ? null : fn(num);
      });
    let p=toSeries(d.price);
    let fb=toSeries(d.funding_binance,v=>v*100);
    let fby=toSeries(d.funding_bybit,v=>v*100);
    let fok=toSeries(d.funding_okx,v=>v*100);
    let b=toSeries(d.basis);
    let o=toSeries(d.oi);
    let dec=symDecimals[currentSym]??2;
    let mk=(id,name,data,axisFmt,color,autoScale=false,desc='')=>{
      let c=echarts.init(document.getElementById(id));
      let yAxis={type:'value',name:name,axisLabel:{formatter:(val)=>axisFmt(val)}};
      if(autoScale){
        const filtered=data.filter(v=>v!=null);
        if(filtered.length){
          const minVal=Math.min(...filtered);
          const maxVal=Math.max(...filtered);
          Object.assign(yAxis,{scale:true,min:minVal,max:maxVal});
        }
      }
      const opt={
        tooltip:{trigger:'axis',formatter:(ps)=>{let p=ps[0];return p.axisValueLabel+'<br/>'+name+': '+axisFmt(p.data);}},
        xAxis:{type:'category',data:x},
        yAxis,
        dataZoom:[{type:'inside'}],
        series:[{name,showSymbol:false,type:'line',data,connectNulls:true,lineStyle:{color},itemStyle:{color}}]
      };
      if(desc){
        opt.title={text:desc,left:'center',textStyle:{fontSize:12}};
      }
      c.setOption(opt);
    };
    mk('derivs-price','Price (USD)',p,v=>'$'+Number(v).toFixed(dec),'#3BA272',true);
    mk('derivs-funding-binance','Funding (%)',fb,v=>Number(v).toFixed(4)+'%','#5470C6',true,'Binance 资费');
    mk('derivs-funding-bybit','Funding (%)',fby,v=>Number(v).toFixed(4)+'%','#91CC75',true,'Bybit 资费');
    mk('derivs-funding-okx','Funding (%)',fok,v=>Number(v).toFixed(4)+'%','#EE6666',true,'OKX 资费');
    mk('derivs-basis','Basis (USD)',b,v=>'$'+Number(v).toFixed(2),'#EE6666');
    mk('derivs-oi','Open Interest',o,v=>Math.round(v).toLocaleString(),'#91CC75',true);
  }else if(currentTab==='orders'){
    initDepthButtons();
    let wrap=document.getElementById('orders-wrap');
    if(!wrap.hasChildNodes()){
      wrap.innerHTML=`<h3>${displaySym(currentSym)} Bids/Asks</h3><div id='orders-chart' style='width:100%;height:600px;border:1px solid #ccc'></div>`;
    }else{
      wrap.querySelector('h3').textContent=`${displaySym(currentSym)} Bids/Asks`;
    }
    let ob=await fetch(`/chart/orders?symbol=${currentSym}&limit=${currentDepth}`).then(r=>r.json());
    if(!ordersChart){
      ordersChart=echarts.init(document.getElementById('orders-chart'));
      ordersChart.on('dataZoom',()=>{
        const dz=ordersChart.getOption().dataZoom?.[0];
        if(dz) ordersZoom[currentSym]={startValue:dz.startValue,endValue:dz.endValue};
      });
    }
    let chart=ordersChart;
    let dec=symDecimals[currentSym]??2;

    // Determine best bid/ask and mid price
    const prices=ob.prices.map(Number);
    const buys=ob.buy.map(Number);
    const sells=ob.sell.map(Number);
    let bestBid=null,bestAsk=null;
    for(let i=prices.length-1;i>=0;i--){
      if(buys[i]>0){bestBid=prices[i];break;}
    }
    for(let i=0;i<prices.length;i++){
      if(sells[i]>0){bestAsk=prices[i];break;}
    }
    let mid=ob.price;
    if(bestBid!=null&&bestAsk!=null) mid=(bestBid+bestAsk)/2;
    else if(bestBid!=null) mid=bestBid;
    else if(bestAsk!=null) mid=bestAsk;
    updateOrdersTitle();
    const refPrice=latestPrice||mid;
    const fPrices=[],fBuys=[],fSells=[];
    for(let i=0;i<prices.length;i++){
      const p=prices[i];
      if(Math.abs(p-refPrice)/refPrice>0.1) continue;
      fPrices.push(p);
      fBuys.push(buys[i]);
      fSells.push(sells[i]);
    }
    const linePrice=refPrice;
    let priceStr=Number(linePrice).toFixed(dec);
    const axisVals=fPrices.map(p=>p.toFixed(dec));
    const lower=linePrice*0.99;
    const upper=linePrice*1.01;
    let startIdx=0,endIdx=axisVals.length-1;
    for(let i=0;i<fPrices.length;i++){
      if(fPrices[i]>=lower){startIdx=i;break;}
    }
    for(let i=fPrices.length-1;i>=0;i--){
      if(fPrices[i]<=upper){endIdx=i;break;}
    }
    let startVal,endVal;
    const saved=ordersZoom[currentSym];
    if(saved){
      startVal=saved.startValue;
      endVal=saved.endValue;
    }else{
      startVal=axisVals[startIdx] ?? axisVals[0];
      endVal=axisVals[endIdx] ?? axisVals[axisVals.length-1];
    }

    chart.setOption({
      tooltip:{},
      legend:{data:['buy','sell']},
      grid:{left:0,right:0,containLabel:true},
      xAxis:{type:'category',data:axisVals,boundaryGap:false},
      yAxis:{type:'value'},
      dataZoom:[{type:'inside',startValue:startVal,endValue:endVal}],
      series:[
        {name:'buy',data:fBuys,type:'bar',markLine:{symbol:'none',lineStyle:{type:'dashed'},data:[{xAxis:priceStr}]}},
        {name:'sell',data:fSells,type:'bar'}
      ]
    });
  }else if(currentTab==='trades'){
    let wrap=document.getElementById('trades-wrap');
    if(!wrap.hasChildNodes()){
      wrap.innerHTML=`<h3>${displaySym(currentSym)}</h3><div id='va-buttons' style='margin:10px 0;display:flex;gap:4px'></div><div id='trades-chart' style='width:100%;height:80vh;border:1px solid #ccc'></div>`;
      initVAButtons();
    }else{
      wrap.querySelector('h3').textContent=displaySym(currentSym);
      initVAButtons();
    }
    let td=await fetch(`/chart/trades?symbol=${currentSym}`).then(r=>r.json());
    const prices=td.prices.map(Number);
    const vols=td.volumes.map(Number);
    const curPrice=latestPrice;
    const binCount=35;
    let tc=echarts.init(document.getElementById('trades-chart'));
    if(prices.length){
      const minP=Math.floor(Math.min(...prices));
      const maxP=Math.ceil(Math.max(...prices));
      const binSize=Math.max(1,Math.ceil((maxP-minP)/binCount));
      const binVolumes=new Array(binCount).fill(0);
      prices.forEach((p,i)=>{
        let idx=Math.floor((p-minP)/binSize);
        if(idx<0) idx=0;
        if(idx>=binCount) idx=binCount-1;
        binVolumes[idx]+=vols[i];
      });
      const binLabels=[];
      const fmtPrice=p=>Math.round(p);
      for(let i=0;i<binCount;i++){
        const start=minP+i*binSize;
        const end=start+binSize;
        binLabels.push(`${fmtPrice(start)}-${fmtPrice(end)}`);
      }
      const totalVol=binVolumes.reduce((a,b)=>a+b,0);
      let pocIdx=binVolumes.indexOf(Math.max(...binVolumes));
      const valueArea=new Set([pocIdx]);
      let acc=binVolumes[pocIdx];
      let left=pocIdx-1,right=pocIdx+1;
      while(acc/totalVol<currentVA&&(left>=0||right<binCount)){
        const lv=left>=0?binVolumes[left]:-1;
        const rv=right<binCount?binVolumes[right]:-1;
        if(lv>=rv){
          if(left>=0){valueArea.add(left);acc+=binVolumes[left];left--;}
          else{valueArea.add(right);acc+=binVolumes[right];right++;}
        }else{
          if(right<binCount){valueArea.add(right);acc+=binVolumes[right];right++;}
          else{valueArea.add(left);acc+=binVolumes[left];left--;}
        }
      }
      const topBins=new Set([...binVolumes.keys()].sort((a,b)=>binVolumes[b]-binVolumes[a]).slice(0,3));
      const colors=binVolumes.map((_,i)=>{
        if(topBins.has(i)) return 'purple';
        if(valueArea.has(i)) return 'blue';
        return '#91CC75';
      });
      for(let i=1;i<colors.length-1;i++){
        if(colors[i]==='#91CC75' && colors[i-1]==='blue' && colors[i+1]==='blue'){
          colors[i]='lightblue';
        }
      }
      const displayVols=binVolumes.slice().reverse();
      const displayLabels=binLabels.slice().reverse();
      const displayColors=colors.slice().reverse();
      let lineLabel='';
      if(curPrice){
        let idx=Math.floor((curPrice-minP)/binSize);
        if(idx<0) idx=0;
        if(idx>=binCount) idx=binCount-1;
        lineLabel=displayLabels[binCount-1-idx];
      }
      const seriesOpt={type:'bar',data:displayVols,barWidth:'60%',itemStyle:{color:(p)=>displayColors[p.dataIndex]}};
      if(lineLabel){
        seriesOpt.markLine={symbol:'none',lineStyle:{type:'dashed',color:'red'},label:{formatter:()=>Math.round(curPrice)},data:[{yAxis:lineLabel}]};
      }
      tc.setOption({
        tooltip:{formatter:p=>`${p.name}: ${Number(p.value).toLocaleString()}`},
        grid:{left:60,right:20,top:20,bottom:20},
        xAxis:{type:'value'},
        yAxis:{type:'category',data:displayLabels},
        dataZoom:[{type:'inside',yAxisIndex:0}],
        series:[seriesOpt]
      });
    }else{
      tc.clear();
    }
  }else if(currentTab==='cancels'){
    let wrap=document.getElementById('cancels-wrap');
    if(!wrap.hasChildNodes()){
      wrap.innerHTML=`<h3>${displaySym(currentSym)}</h3><div id='cancels-line' style='width:800px;height:320px;border:1px solid #ccc;margin-top:10px'></div>`;
    }else{
      wrap.querySelector('h3').textContent=displaySym(currentSym);
    }
    let d=await fetch(`/chart/cancels?symbol=${currentSym}`).then(r=>r.json());
    let chart=echarts.init(document.getElementById('cancels-line'));
    let x=toUTC8(d.timestamps);
    chart.setOption({tooltip:{trigger:'axis'},xAxis:{type:'category',data:x},yAxis:{type:'value'},dataZoom:[{type:'inside'}],series:[{data:d.counts,type:'line'}]});
  }
}
setInterval(load,5000);
setInterval(refreshPrice,5000);
refreshPrice().then(load);

async function triggerBackfill(hours,btn){
  const note=document.getElementById('backfill-note');
  btn.disabled=true; const orig=btn.textContent; btn.textContent='回填中...'; note.textContent='';
  try{
    const res=await fetch(`/backfill/derivs?hours=${hours}`,{method:'POST'});
    const data=await res.json();
    note.textContent='回填完成: '+JSON.stringify(data.inserted_points||data);
    // 触发一次加载刷新图表
    load();
  }catch(e){
    note.textContent='回填失败: '+(e?.message||e);
  }finally{
    btn.disabled=false; btn.textContent=orig;
  }
}
</script>
</body>
</html>
